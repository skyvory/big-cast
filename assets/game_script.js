"use strict";function callConfigurationData(e){var a=$.ajax({url:config.base+"index.php/game/loadConfiguration",type:"POST",dataType:"json"});a.done(function(a){a&&(configuration=a),e()})}function callSequentialLineData(e,a){var n=60,t=$.ajax({url:config.base+"index.php/game/loadLine",type:"POST",data:{offset:e,limit:n},dataType:"json"});t.done(function(e){e.length?($.each(e,function(a){line.push(e[a])}),current.head+=e.length,a&&a()):0==current.sequence&&callFailureNotification("No data retrieved.")})}function maintainCurrent(e){if(current.head>current.limit)for(var a=0;a<current.sequence-10;a++)line.splice(0,1),current.head--,current.sequence--,cache.head--;current.sequence%(current.head-20)==0&&callSequentialLineData(parseInt(line[current.head].sequence)),e&&e()}function maintainCache(e){cache.count>cache.limit&&($("image-cache").children("img").each(function(){for(var e=$(this).find("id").val(),a=!0,n=!0,t=current.sequence;t<current.sequence+10;t++){1==line[t].fk_linetype_id&&(line[t].background_resource_id&&e==line[t].background_resource_id&&(a=!1),line[t].sprite.length&&$.each(line[t].sprite,function(a,t){e==t.sprite_resource_id&&(n=!0)}))}1==a&&($(this).remove(),cache.count--),1==n&&($(this).remove(),cache.count--)}),$("audio-cache").children("audio").each(function(){for(var e=$(this).find("id").val(),a=!0,n=!0,t=!0,i=current.sequence;i<current.sequence+10;i++){1==line[i].fk_linetype_id&&(line[i].bgm_resource_id&&e==line[i].bgm_resource_id&&(a=!1),line[i].sfx_resource_id&&e==line[i].sfx_resource_id&&(n=!1),line[i].voice_resource_id&&e==line[i].voice_resource_id&&(t=!1))}1==a&&($(this).remove(),cache.count--),1==n&&($(this).remove(),cache.count--),1==t&&($(this).remove(),cache.count--)})),processSequentialResource(),e&&e()}function processSequentialResource(){if(cache.head-current.sequence<10&&(cache.head++,line[cache.head]))if(1==line[cache.head].fk_linetype_id){var e=!0;if(line[cache.head].background_resource_id){var a="../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/background/"+line[cache.head].background_file_name,n=line[cache.head].background_resource_id;preloadImage(a,n,function(a){a||(e=!1)})}if(line[cache.head].sprite.length){var t=[];$.each(line[cache.head].sprite,function(e,a){var n="../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/sprite/"+a.sprite_file_name,i=a.sprite_resource_id;t.push({source:n,resource_id:i})}),preloadSprite(t,function(a){a||(e=!1)})}if(line[cache.head].bgm_resource_id){var i="../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/bgm/"+line[cache.head].bgm_file_name,n=line[cache.head].bgm_resource_id;preloadAudio(i,n,function(a){a||(e=!1)})}if(line[cache.head].voice_resource_id){var c="../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/voice/"+line[cache.head].voice_file_name,n=line[cache.head].voice_resource_id;preloadAudio(c,n,function(a){a||(e=!1)})}if(line[cache.head].sfx_resource_id){var r="../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/sfx/"+line[cache.head].sfx_file_name,n=line[cache.head].sfx_resource_id;preloadAudio(r,n,function(a){a||(e=!1)})}1==e&&processSequentialResource()}else 2==line[cache.head].fk_linetype_id,processSequentialResource()}function preloadImage(e,a,n){var t=$(".image-cache").has("img[id="+a+"]").length;t?n(!0):($("<img/>").attr("src",e).attr("id",a).css("display","none").appendTo(".image-cache"),cache.count++,$("img[id="+a+"]").on("load",function(){n(!0)}))}function preloadSprite(e,a){$.each(e,function(n,t){var i=$(".image-cache").has("img[id="+t.resource_id+"]").length;i?a(!0):($("<img/>").attr("src",t.source).attr("id",t.resource_id).css("display","none").appendTo(".image-cache"),cache.count++,$("img[id="+t.resource_id+"]").on("load",function(){n==e.length&&a(!0)}))})}function preloadAudio(e,a,n){var t=$(".audio-cache").has("audio[id="+a+"]").length;t?n(!0):($("<audio/>").attr("src",e).attr("id",a).attr("preload","auto").css("display","none").appendTo(".audio-cache"),cache.count++,$("audio[id="+a+"]").on("canplaythrough",function(){n(!0)}))}function preloadInterface(e){var a={title_background:"arc_000135c.png",configuration_background:"arc_000018c.png",start_button:"arc_001261.png",load_button:"arc_001264.png",configuration_button:"arc_001267.png",continue_button:"continue.png",in_configuration_button:"arc_001113.png",in_repeat_button:"arc_001119.png",in_auto_button:"arc_001131.png",in_skip_button:"arc_001125.png",in_log_button:"arc_001140.png",in_save_button:"arc_001143.png",in_load_button:"arc_001146.png",in_quicksave_button:"arc_001149.png",in_quickload_button:"arc_001152.png",in_text_window:"arc_000770c.png",in_choice_box:"arc_001255.png",save_data_box_nodata:"arc_000951.png",save_data_box:"arc_000951e.png",text_button:"arc_000573.png",sound_button:"arc_000572.png",exit_button:"arc_001273.png",white:"white.jpg",black:"black.jpg"};if($.each(a,function(e,a){var n="../../../assets/sys/"+a;$("<img/>").attr("src",n).attr("id",e).css("display","none").appendTo(".interface")}),1==config.title_background){$("<img/>").attr("src","../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/title.jpg").attr("id","custom_title_background").css("display","none").appendTo(".interface")}1==config.savedata_background&&$("<img/>").attr("src","../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/savedata.jpg").attr("id","custom_savedata_background").css("display","none").appendTo(".interface"),1==config.configuration_background&&$("<img/>").attr("src","../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/config.jpg").attr("id","custom_configuration_background").css("display","none").appendTo(".interface"),e&&e()}function callFontData(){var e=$.ajax({url:config.base+"index.php/game/loadFontList",dataType:"json"});e.done(function(e){e&&(font_list=e)})}function failureNotification(e){$(".game-area").html("<p/>"+e).show()}function getObjectIndex(e,a,n){for(var t=0;t<e.length;t++)if(e[t][a]==n)return t;return!1}function initializeGame(){$(".request-loading").fadeOut(500,function(){$(".visual-area").fadeIn(1500,function(){renderTitleScreen()})})}function renderTitleScreen(){if(1==config.title_background)var e=$("#custom_title_background")[0];else var e=$("#title_background")[0];var a=new fabric.Image(e,{id:"title_background",top:0,left:0,opacity:0,angle:0,scaleX:1});a.set("selectable",!1),canvas.add(a),a.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:2e3,easing:fabric.util.ease.easeInOutQuad,onComplete:function(){renderTitleMenu()}})}function renderTitleMenu(){var e=$("#start_button")[0],a=new fabric.Image(e,{id:"start_button",top:380,left:300,opacity:0,angle:0});a.set("selectable",!1),canvas.add(a),a.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:500}),a.animate("top","400",{onChange:canvas.renderAll.bind(canvas),duration:500,easing:fabric.util.ease.easeInOutCubic});var e=$("#continue_button")[0],n=new fabric.Image(e,{id:"continue_button",top:380,left:400,opacity:0,angle:0});n.set("selectable",!1),canvas.add(n),n.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:500}),n.animate("top","400",{onChange:canvas.renderAll.bind(canvas),duration:500,easing:fabric.util.ease.easeInOutCubic});var e=$("#load_button")[0],a=new fabric.Image(e,{id:"load_button",top:380,left:500,opacity:0,angle:0});a.set("selectable",!1),canvas.add(a),a.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:500}),a.animate("top","395",{onChange:canvas.renderAll.bind(canvas),duration:500,easing:fabric.util.ease.easeInOutCubic});var e=$("#configuration_button")[0],t=new fabric.Image(e,{id:"configuration_button",top:380,left:600,opacity:0,angle:0});t.set("selectable",!1),canvas.add(t),t.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:500}),t.animate("top","395",{onChange:canvas.renderAll.bind(canvas),duration:500,easing:fabric.util.ease.easeInOutCubic});var e=$("#exit_button")[0],i=new fabric.Image(e,{id:"exit_button",top:380,left:700,opacity:0,angle:0});i.set("selectable",!1),canvas.add(i),i.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:500}),i.animate("top","395",{onChange:canvas.renderAll.bind(canvas),duration:500,easing:fabric.util.ease.easeInOutCubic})}function toggleFullscreen(){if("normal"==game.mode){var e=$(".game-area")[0];e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen();var a=screen.height,n=a/6*8,t=(screen.width-n)/2,i=2/3*a;a+="px",n+="px",t+="px",i+="px";var c=$(".upper-canvas")[0];c.style.height=a,c.style.width=n;var r=$(".lower-canvas")[0];r.style.height=a,r.style.width=n,text_display.style.height=a,text_display.style.width=n,$(".visual-area").css("left",t),$(".text-area").css("left",t),$(".video-area").css("left",t),$(".log-area").css("width",n).css("height",i).css("left",t),game.mode="fullscreen"}else if(game.mode="fullscreen"){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen();var c=$(".upper-canvas")[0];c.style.height="600px",c.style.width="800px";var r=$(".lower-canvas")[0];r.style.height="600px",r.style.width="800px",text_display.style.height="600px",text_display.style.width="800px",$(".visual-area").css("left",""),$(".text-area").css("left",""),$(".video-area").css("left",""),$(".log-area").css("width","800px").css("height","430px").css("left",""),game.mode="normal"}}function renderNotification(e){var a=new fabric.Text(e,{fontFamily:"Arial",fontSize:20,fill:"#FF0000",opacity:0,top:380,left:801});a.set("selectable",!1),canvas.add(a),a.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:500,onComplete:function(){a.animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:2e3})}}),a.animate("left","500",{onChange:canvas.renderAll.bind(canvas),duration:2500,onComplete:function(){canvas.remove(a)}})}function saveGame(e,a){e=e?e:"new";var n=$.ajax({url:config.base+"index.php/game/saveGame",data:{saveid:e,lineid:line[current.sequence].line_id},type:"POST",dataType:"html"});n.done(function(){a&&a()})}function callSaveConfiguration(){{var e=JSON.stringify(configuration);$.ajax({url:config.base+"index.php/game/saveConfiguration",type:"POST",data:{configdata:e}})}}function loadGame(e){var a=$.ajax({url:config.base+"index.php/game/getSequenceById",type:"POST",data:{lineid:e},dataType:"html"});a.done(function(e){whiteIn(1e3),stopBgm(),line=[],canvas.clear(),context.clearRect(0,0,text_display.width,text_display.height),$(".text-area").show(),current.sequence=-1,current.head=-1,cache.head=-1,callSequentialLineData(e-1,function(){processSequentialResource(),setTimeout(function(){game.screen="play",renderNextLine()},4e3)})})}function quickSave(){var e=$.ajax({url:config.base+"index.php/game/quickSave",type:"POST",data:{lineid:line[current.sequence].line_id},dataType:"html"});e.done(function(e){1==e&&renderNotification("Saved!")})}function quickLoad(){var e=$.ajax({url:config.base+"index.php/game/quickLoad",type:"POST",dataType:"html"});e.done(function(e){e&&(game.screen="stall",whiteIn(1e3),stopBgm(),line=[],canvas.clear(),context.clearRect(0,0,text_display.width,text_display.height),$(".text-area").show(),current.sequence=-1,current.head=-1,cache.head=-1,callSequentialLineData(e-1,function(){processSequentialResource(),setTimeout(function(){game.screen="play",renderNextLine()},4e3)}))})}function renderSaveScreen(){var e=$.ajax({url:config.base+"index.php/game/loadSaveData",type:"POST",dataType:"json"});e.done(function(e){var a=e;if(1==config.savedata_background)var n=$("#custom_savedata_background")[0];else var n=$("#configuration_background")[0];var t=new fabric.Image(n,{id:"configuration_background",top:-600,left:0,opacity:1,angle:0});t.set("selectable",!1),canvas.add(t),t.animate("top","0",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack});var i=new fabric.Text("Save Data",{id:"save_head",fontFamily:"Arial",fontSize:40,top:-60,left:100,opacity:1});i.set("selectable",!1),canvas.add(i),i.animate("top","40",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack});var c=$("#save_data_box_nodata")[0],n=$("#save_data_box")[0];if(a.length){var r,o,s=0;for($.each(a,function(e,a){r=130+90*(s%5),o=30,s>=5&&(o=420);var t=new fabric.Image(n,{opacity:1,angle:0}),i=new fabric.Text((s+1).toString(),{fontSize:35,fontWeight:"bold",fontFamily:"Arial",fill:"#0000FF",stroke:"#333333",strokewidth:3,opacity:1,top:18,left:50}),c=new fabric.Text(a.save_date.toString(),{fontSize:20,fontFamily:"Arial",opacity:1,top:40,left:140}),d=new fabric.Group([t,i,c],{id:"save_slot",save_slot_id:s+1,save_data_id:a.savedata_id,save_data_line_id:a.fk_line_id,top:-200,left:o});d.set("selectable",!1),canvas.add(d),d.animate("top",r,{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack}),s++}),s=s;10>s;s++){r=130+90*(s%5),o=30,s>=5&&(o=420);var d=new fabric.Image(c,{id:"save_slot",save_slot_id:s+1,top:-200,left:o,opacity:1,angle:0});d.set("selectable",!1),canvas.add(d),d.animate("top",r,{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack})}}else{for(var r=130,s=0;5>s;s++){var l=new fabric.Image(c,{id:"save_slot",save_slot_id:s+1,top:-200,left:30,opacity:.8,angle:0});l.set("selectable",!1),canvas.add(l),l.animate("top",r,{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack}),r+=90}var r=130;for(s=s;10>s;s++){var l=new fabric.Image(c,{id:"save_slot",save_slot_id:s+1,top:-200,left:420,opacity:.8,angle:0});l.set("selectable",!1),canvas.add(l),l.animate("top",r,{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack}),r+=90}}var n=$("#exit_button")[0],u=new fabric.Image(n,{id:"exit_button",top:-600,left:730,opacity:1,angle:0});u.set("selectable",!1),canvas.add(u),u.animate("top","10",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack})})}function renderLoadScreen(){var e=$.ajax({url:config.base+"index.php/game/loadSaveData",type:"POST",dataType:"json"});e.done(function(e){if(1==config.savedata_background)var a=$("#custom_savedata_background")[0];else var a=$("#configuration_background")[0];var n=new fabric.Image(a,{id:"configuration_background",top:-600,left:0,opacity:1,angle:0});n.set("selectable",!1),canvas.add(n),n.animate("top","0",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack});var t=new fabric.Text("Load Data",{id:"load_head",fontFamily:"Arial",fontSize:40,top:-60,left:100,opacity:1});t.set("selectable",!1),canvas.add(t),t.animate("top","40",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack});var i=$("#save_data_box_nodata")[0],a=$("#save_data_box")[0];if(e.length){var c,r,o=0;for($.each(e,function(e,n){c=130+90*(o%5),r=30,o>=5&&(r=420);var t=new fabric.Image(a,{opacity:1,angle:0}),i=new fabric.Text((o+1).toString(),{fontSize:35,fontWeight:"bold",fontFamily:"Arial",fill:"#0000FF",stroke:"#333333",strokewidth:3,opacity:1,top:18,left:50}),s=new fabric.Text(n.save_date.toString(),{fontSize:20,fontFamily:"Arial",opacity:1,top:40,left:140}),d=new fabric.Group([t,i,s],{id:"save_slot",save_slot_id:o+1,save_data_id:n.savedata_id,save_data_line_id:n.fk_line_id,top:-200,left:r});d.set("selectable",!1),canvas.add(d),d.animate("top",c,{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack}),o++}),o=o;10>o;o++){c=130+90*(o%5),r=30,o>=5&&(r=420);var s=new fabric.Image(i,{id:"save_slot",save_slot_id:o+1,top:-200,left:r,opacity:.7,angle:0});s.set("selectable",!1),canvas.add(s),s.animate("top",c,{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack})}}else{for(var c=130,o=0;5>o;o++){var d=new fabric.Image(i,{id:"save_slot",save_slot_id:o+1,top:-200,left:30,opacity:.8,angle:0});d.set("selectable",!1),canvas.add(d),d.animate("top",c,{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack}),c+=90}var c=130;for(o=o;10>o;o++){var d=new fabric.Image(i,{id:"save_slot",save_slot_id:o+1,top:-200,left:420,opacity:.8,angle:0});d.set("selectable",!1),canvas.add(d),d.animate("top",c,{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack}),c+=90}}var a=$("#exit_button")[0],l=new fabric.Image(a,{id:"exit_button",top:-600,left:730,opacity:1,angle:0});l.set("selectable",!1),canvas.add(l),l.animate("top","10",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack})})}function exitLoadScreen(e){for(var a=0;10>a;a++){var n=getObjectIndex(canvas.getObjects(),"save_slot_id",a+1);canvas.item(n).animate("top","-200",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack,onComplete:function(){for(a=0;10>a;a++){var e=getObjectIndex(canvas.getObjects(),"save_slot_id",a+1);canvas.remove(canvas.item(e))}}})}n=getObjectIndex(canvas.getObjects(),"id","load_head"),canvas.item(n).animate("top","-200",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack,onComplete:function(){n=getObjectIndex(canvas.getObjects(),"id","load_head"),canvas.remove(canvas.item(n))}}),n=getObjectIndex(canvas.getObjects(),"id","exit_button"),canvas.item(n).animate("top","-600",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack,onComplete:function(){n=getObjectIndex(canvas.getObjects(),"id","exit_button"),canvas.remove(canvas.item(n))}}),n=getObjectIndex(canvas.getObjects(),"id","configuration_background"),canvas.item(n).animate("top","-600",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack,onComplete:function(){n=getObjectIndex(canvas.getObjects(),"id","configuration_background"),canvas.remove(canvas.item(n))}}),setTimeout(function(){e&&e()},1e3)}function exitSaveScreen(e){for(var a=0;10>a;a++){var n=getObjectIndex(canvas.getObjects(),"save_slot_id",a+1);canvas.item(n).animate("top","-200",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack,onComplete:function(){for(a=0;10>a;a++){var e=getObjectIndex(canvas.getObjects(),"save_slot_id",a+1);canvas.remove(canvas.item(e))}}})}n=getObjectIndex(canvas.getObjects(),"id","save_head"),canvas.item(n).animate("top","-200",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack,onComplete:function(){n=getObjectIndex(canvas.getObjects(),"id","save_head"),canvas.remove(canvas.item(n))}}),n=getObjectIndex(canvas.getObjects(),"id","exit_button"),canvas.item(n).animate("top","-600",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack,onComplete:function(){n=getObjectIndex(canvas.getObjects(),"id","exit_button"),canvas.remove(canvas.item(n))}}),n=getObjectIndex(canvas.getObjects(),"id","configuration_background"),canvas.item(n).animate("top","-600",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack,onComplete:function(){n=getObjectIndex(canvas.getObjects(),"id","configuration_background"),canvas.remove(canvas.item(n))}}),setTimeout(function(){e&&e()},1e3)}function renderConfigurationScreen(e){if(1==config.configuration_background)var a=$("#custom_configuration_background")[0];else var a=$("#configuration_background")[0];var n=new fabric.Image(a,{id:"configuration_background",top:-600,left:0,opacity:1,angle:0});n.set("selectable",!1),canvas.add(n),n.animate("top","0",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack});var t=new fabric.Text("Configuration",{id:"configuration_head",fontFamily:"Arial",fontSize:40,top:-60,left:100,opacity:1});t.set("selectable",!1),canvas.add(t),t.animate("top","40",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack});var a=$(".interface").find("img[id=text_button]")[0],t=new fabric.Image(a,{id:"text_head",top:-60,left:130,opacity:.8,originX:"center"});t.set("selectable",!1),canvas.add(t),t.animate("top","130",{onChange:canvas.renderAll.bind(canvas),duration:800,easing:fabric.util.ease.easeInOutBack});var a=$(".interface").find("img[id=sound_button]")[0],t=new fabric.Image(a,{id:"sound_head",top:-60,left:360,opacity:1,originX:"center"});t.set("selectable",!1),canvas.add(t),t.animate("top","125",{onChange:canvas.renderAll.bind(canvas),duration:800,easing:fabric.util.ease.easeInOutBack}),setTimeout(function(){for(var e=220,a=0;a<font_list.length;a++){var n=new fabric.Text(font_list[a].name,{id:"font",fonttype_id:font_list[a].fonttype_id,fontFamily:font_list[a].name,fontSize:28,top:e,left:-300,opacity:1,fill:"#000000",textAlign:"left"});configuration.fk_fonttype_id==font_list[a].fonttype_id&&n.set("opacity",.5),n.set("selectable",!1),canvas.add(n),n.animate("left","80",{onChange:canvas.renderAll.bind(canvas),duration:500,easing:fabric.util.ease.easeInOutBack}),e+=45}},1e3),setTimeout(function(){var e=new fabric.Text("Speed",{id:"text_speed_head",fontFamily:"Arial",fontSize:30,top:230,left:-80,opacity:1});e.set("selectable",!1),canvas.add(e),e.animate("left","400",{onChange:canvas.renderAll.bind(canvas),duration:300,easing:fabric.util.ease.easeInOutBack});for(var a=420,n=0;10>=n;n++){var e=new fabric.Text(n.toString(),{id:"text",textspeed_id:n,fontFamily:"Arial",fontSize:30,top:300,left:-400,opacity:1,fill:"#000000",textAlign:"left"});configuration.text_speed==n&&e.set("opacity",.5),e.set("selectable",!1),canvas.add(e),e.animate("left",a,{onChange:canvas.renderAll.bind(canvas),duration:300,easing:fabric.util.ease.easeInOutBack}),a+=30}},1500);var a=$("#exit_button")[0],i=new fabric.Image(a,{id:"exit_button",top:-600,left:730,opacity:1,angle:0});i.set("selectable",!1),canvas.add(i),i.animate("top","10",{onChange:canvas.renderAll.bind(canvas),duration:1e3,easing:fabric.util.ease.easeInOutBack}),setTimeout(function(){var e=new fabric.Text("BGM Volume",{id:"bgm_head",fontFamily:"Arial",fontSize:30,top:230,left:810,opacity:1});e.set("selectable",!1),canvas.add(e);for(var a=70,n=0;10>=n;n++){var t=n/10,e=new fabric.Text(n.toString(),{id:"bgm",bgmvolume_id:n,fontFamily:"Arial",fontSize:30,top:280,left:810,opacity:1,fill:"#000000",textAlign:"left"});configuration.bgm_volume==t&&e.set("opacity",.5),e.set("selectable",!1),canvas.add(e),a+=30}var e=new fabric.Text("SFX Volume",{id:"sfx_head",fontFamily:"Arial",fontSize:30,top:330,left:810,opacity:1});e.set("selectable",!1),canvas.add(e);for(var a=70,n=0;10>=n;n++){var t=n/10,e=new fabric.Text(n.toString(),{id:"sfx",sfxvolume_id:n,fontFamily:"Arial",fontSize:30,top:380,left:810,opacity:1,fill:"#000000",textAlign:"left"});configuration.sfx_volume==t&&e.set("opacity",.5),e.set("selectable",!1),canvas.add(e),a+=30}var e=new fabric.Text("Voice Volume",{id:"voice_head",fontFamily:"Arial",fontSize:30,top:430,left:810,opacity:1});e.set("selectable",!1),canvas.add(e);for(var a=70,n=0;10>=n;n++){var t=n/10,e=new fabric.Text(n.toString(),{id:"voice",voicevolume_id:n,fontFamily:"Arial",fontSize:30,top:480,left:810,opacity:1,fill:"#000000",textAlign:"left"});configuration.voice_volume==t&&e.set("opacity",.5),e.set("selectable",!1),canvas.add(e),a+=30}},2e3),setTimeout(function(){e&&e()},2e3)}function toTextConfiguration(){var e=getObjectIndex(canvas.getObjects(),"id","text_head"),a=canvas.item(e);a.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:100}),e=getObjectIndex(canvas.getObjects(),"id","sound_head"),a=canvas.item(e),a.animate("opacity","0.8",{onChange:canvas.renderAll.bind(canvas),duration:100});for(var n=0;10>=n;n++){var t=getObjectIndex(canvas.getObjects(),"bgmvolume_id",n);canvas.item(t).animate("left","810",{onChange:canvas.renderAll.bind(canvas),duration:500})}for(var n=0;10>=n;n++){var t=getObjectIndex(canvas.getObjects(),"sfxvolume_id",n);canvas.item(t).animate("left","810",{onChange:canvas.renderAll.bind(canvas),duration:500})}for(var n=0;10>=n;n++){var t=getObjectIndex(canvas.getObjects(),"voicevolume_id",n);canvas.item(t).animate("left","810",{onChange:canvas.renderAll.bind(canvas),duration:500})}setTimeout(function(){var e=getObjectIndex(canvas.getObjects(),"id","bgm_head");canvas.item(e).animate("left","810",{onChange:canvas.renderAll.bind(canvas),duration:500});var e=getObjectIndex(canvas.getObjects(),"id","sfx_head");canvas.item(e).animate("left","810",{onChange:canvas.renderAll.bind(canvas),duration:500});var e=getObjectIndex(canvas.getObjects(),"id","voice_head");canvas.item(e).animate("left","810",{onChange:canvas.renderAll.bind(canvas),duration:500});for(var a=0;a<font_list.length;a++){var e=getObjectIndex(canvas.getObjects(),"fonttype_id",font_list[a].fonttype_id),n=canvas.item(e);n.animate("left","80",{onChange:canvas.renderAll.bind(canvas),duration:500})}var e=getObjectIndex(canvas.getObjects(),"id","text_speed_head"),n=canvas.item(e);n.animate("left","400",{onChange:canvas.renderAll.bind(canvas),duration:500,easing:fabric.util.ease.easeInOutBack});for(var t=420,a=0;10>=a;a++){var i=getObjectIndex(canvas.getObjects(),"textspeed_id",a),n=canvas.item(i);n.animate("left",t,{onChange:canvas.renderAll.bind(canvas),duration:500}),t+=30}},2e3)}function toSoundConfiguration(){var e=getObjectIndex(canvas.getObjects(),"id","text_head"),a=canvas.item(e);a.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:100}),e=getObjectIndex(canvas.getObjects(),"id","sound_head"),a=canvas.item(e),a.animate("opacity","0.8",{onChange:canvas.renderAll.bind(canvas),duration:100});for(var n=0;n<font_list.length;n++){var e=getObjectIndex(canvas.getObjects(),"fonttype_id",font_list[n].fonttype_id),a=canvas.item(e);a.animate("left","-400",{onChange:canvas.renderAll.bind(canvas),duration:300})}for(var n=0;10>=n;n++){var e=getObjectIndex(canvas.getObjects(),"textspeed_id",n),a=canvas.item(e);a.animate("left","-400",{onChange:canvas.renderAll.bind(canvas),duration:300})}var e=getObjectIndex(canvas.getObjects(),"id","text_speed_head"),a=canvas.item(e);a.animate("left","-100",{onChange:canvas.renderAll.bind(canvas),duration:300}),setTimeout(function(){var e=getObjectIndex(canvas.getObjects(),"id","bgm_head");canvas.item(e).animate("left","50",{onChange:canvas.renderAll.bind(canvas),duration:300,onComplete:function(){for(var e=70,a=0;10>=a;a++){var n=getObjectIndex(canvas.getObjects(),"bgmvolume_id",a),t=canvas.item(n);t.animate("left",e,{onChange:canvas.renderAll.bind(canvas),duration:300}),e+=30}}});var e=getObjectIndex(canvas.getObjects(),"id","sfx_head");canvas.item(e).animate("left","50",{onChange:canvas.renderAll.bind(canvas),duration:300,onComplete:function(){for(var e=70,a=0;10>=a;a++){var n=getObjectIndex(canvas.getObjects(),"sfxvolume_id",a),t=canvas.item(n);t.animate("left",e,{onChange:canvas.renderAll.bind(canvas),duration:300}),e+=30}}});var e=getObjectIndex(canvas.getObjects(),"id","voice_head");canvas.item(e).animate("left","50",{onChange:canvas.renderAll.bind(canvas),duration:300,onComplete:function(){for(var e=70,a=0;10>=a;a++){var n=getObjectIndex(canvas.getObjects(),"voicevolume_id",a),t=canvas.item(n);t.animate("left",e,{onChange:canvas.renderAll.bind(canvas),duration:300}),e+=30}}})},1500)}function exitConfigurationScreen(){for(var e=0;e<font_list.length;e++){var a=getObjectIndex(canvas.getObjects(),"fonttype_id",font_list[e].fonttype_id);canvas.item(a).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:500,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"id","text_head");canvas.item(e).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:300});var e=getObjectIndex(canvas.getObjects(),"id","sound_head");canvas.item(e).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:300})}})}for(var e=0;10>=e;e++){var a=getObjectIndex(canvas.getObjects(),"voicevolume_id",e);canvas.item(a).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:300,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"id","voice_head");canvas.item(e).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:300})}})}for(var e=0;10>=e;e++){var a=getObjectIndex(canvas.getObjects(),"sfxvolume_id",e);canvas.item(a).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:600,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"id","sfx_head");canvas.item(e).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:300})}})}for(var e=0;10>=e;e++){var a=getObjectIndex(canvas.getObjects(),"textspeed_id",e);canvas.item(a).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:600,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"id","text_speed_head");canvas.item(e).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:300})}})}for(var e=0;10>=e;e++){var a=getObjectIndex(canvas.getObjects(),"bgmvolume_id",e);canvas.item(a).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:900,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"id","bgm_head");canvas.item(e).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:300,onComplete:function(){e=getObjectIndex(canvas.getObjects(),"id","configuration_head"),canvas.item(e).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:300,onComplete:function(){e=getObjectIndex(canvas.getObjects(),"id","exit_button"),canvas.item(e).animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:300,easing:fabric.util.ease.easeInOutBack,onComplete:function(){e=getObjectIndex(canvas.getObjects(),"id","configuration_background"),canvas.item(e).animate("top","-600",{onChange:canvas.renderAll.bind(canvas),duration:500,easing:fabric.util.ease.easeInOutBack,onComplete:function(){for($(text_display).fadeIn(500),e=getObjectIndex(canvas.getObjects(),"id","configuration_head"),canvas.remove(canvas.item(e)),e=getObjectIndex(canvas.getObjects(),"id","text_head"),canvas.remove(canvas.item(e)),e=getObjectIndex(canvas.getObjects(),"id","sound_head"),canvas.remove(canvas.item(e)),e=getObjectIndex(canvas.getObjects(),"id","text_speed_head"),canvas.remove(canvas.item(e)),e=getObjectIndex(canvas.getObjects(),"id","bgm_head"),canvas.remove(canvas.item(e)),e=getObjectIndex(canvas.getObjects(),"id","sfx_head"),canvas.remove(canvas.item(e)),e=getObjectIndex(canvas.getObjects(),"id","voice_head"),canvas.remove(canvas.item(e)),a=0;10>=a;a++){var e=getObjectIndex(canvas.getObjects(),"textspeed_id",a);canvas.remove(canvas.item(e))}for(a=0;10>=a;a++){var e=getObjectIndex(canvas.getObjects(),"sfxvolume_id",a);canvas.remove(canvas.item(e))}for(a=0;10>=a;a++){var e=getObjectIndex(canvas.getObjects(),"bgmvolume_id",a);canvas.remove(canvas.item(e))}for(a=0;10>=a;a++){var e=getObjectIndex(canvas.getObjects(),"voicevolume_id",a);canvas.remove(canvas.item(e))}e=getObjectIndex(canvas.getObjects(),"id","exit_button"),canvas.remove(canvas.item(e)),e=getObjectIndex(canvas.getObjects(),"id","configuration_background"),canvas.remove(canvas.item(e));for(var a=0;a<font_list.length;a++){var e=getObjectIndex(canvas.getObjects(),"fonttype_id",font_list[a].fonttype_id);canvas.remove(canvas.item(e))}}})}})}})}})}})}}function renderPlayScreen(){whiteIn(100,function(){canvas.clear(),renderNextLine()})}function whiteIn(e,a){var n=$("#white")[0],t=new fabric.Image(n,{id:"white",top:0,left:0,opacity:0,angle:0});t.set("selectable",!1),canvas.add(t),t.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:e,onComplete:function(){a&&a()}})}function whiteOut(e,a){var n=getObjectIndex(canvas.getObjects(),"id","white"),t=canvas.item(n);t.animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:e,onComplete:function(){n=getObjectIndex(canvas.getObjects(),"id","white"),canvas.remove(canvas.item(n)),a&&a()
}})}function blackIn(e,a){var n=$("#black")[0],t=new fabric.Image(n,{id:"black",top:0,left:0,opacity:0,angle:0});t.set("selectable",!1),canvas.add(t),t.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:e,onComplete:function(){a&&a()}})}function blackOut(e,a){var n=getObjectIndex(canvas.getObjects(),"id","black"),t=canvas.item(n);t.animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:e,onComplete:function(){n=getObjectIndex(canvas.getObjects(),"id","black"),canvas.remove(canvas.item(n)),a&&a()}})}function compareSpriteIndex(e,a){return e.position_z<a.position_z?-1:e.position_z>a.position_z?1:0}function renderNextLine(e){if(context.clearRect(0,0,text_display.width,text_display.height),current.sequence++,(1==line[current.sequence].fk_linetype_id||3==line[current.sequence].fk_linetype_id)&&line[current.sequence].jumpto_line_id&&(game.screen="stall",line[current.sequence].jumpto_line_id&&line[current.sequence].jumpto_line_id!=line[current.sequence+1].line_id)){var a=current.sequence+1;line.splice(a,current.head-current.sequence),current.head=current.sequence,cache.head=current.sequence;var n=line[current.sequence].look_ahead[0].sequence;callSequentialLineData(parseInt(n)-1,function(){processSequentialResource(),setTimeout(function(){game.screen="play"},1e3)})}if(1===parseInt(line[current.sequence].fk_linetype_id)){if(current.sequence>0){for(var t=-1,i=current.sequence-1;i>=0;i--)1===parseInt(line[i].fk_linetype_id)&&(t=i,i=-1);if(t>-1){if(line[t].background_resource_id===line[current.sequence].background_resource_id);else{if(line[current.sequence].background_resource_id>0){line[current.sequence].background_resource_id;var c=line[current.sequence].background_resource_id,r=$(".image-cache").find("img[id="+c+"]")[0];if("skip"==game.screen){var o=new fabric.Image(r,{line_background_resource_id:c,top:0,left:0,opacity:1});o.set("selectable",!1),canvas.add(o),line[current.sequence].content.length>0&&canvas.sendToBack(o)}else{var o=new fabric.Image(r,{line_background_resource_id:c,top:0,left:0,opacity:0});o.set("selectable",!1),canvas.add(o),line[current.sequence].content.length>0,o.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:800,onComplete:function(){}})}}if(line[t].background_resource_id.length>0){var s=getObjectIndex(canvas.getObjects(),"line_background_resource_id",line[t].background_resource_id),d=canvas.item(s);"skip"==game.screen?canvas.remove(canvas.item(s)):d.animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:1e3,onComplete:function(){s=getObjectIndex(canvas.getObjects(),"line_background_resource_id",line[t].background_resource_id),canvas.remove(canvas.item(s))}})}}if(line[current.sequence].sprite.length>0)if(line[current.sequence].sprite.length>1&&line[current.sequence].sprite.sort(compareSpriteIndex),"skip"==game.screen)line[t].sprite.length>0&&$.each(line[t].sprite,function(e,a){var n=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(n))}),line[current.sequence].sprite.length>0&&$.each(line[current.sequence].sprite,function(e,a){var n=$(".image-cache").find("img[id="+a.sprite_resource_id+"]")[0],t=new fabric.Image(n,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:100*a.position_x,opacity:1});t.set("selectable",!1),canvas.add(t)});else{var l=[],i=0;$.each(line[t].sprite,function(e,a){var n=!1;$.each(line[current.sequence].sprite,function(e,t){a.sprite_resource_id==t.sprite_resource_id&&(n=!0)}),0==n&&l.push(line[t].sprite[i]),i++}),$.each(line[current.sequence].sprite,function(e,a){if(line[t].sprite.length>0){var n=!1,i=!1,c=getObjectIndex(line[t].sprite,"sprite_resource_id",a.sprite_resource_id);if(line[t].sprite[c]){if(a.sprite_resource_id==line[t].sprite[c].sprite_resource_id&&a.position_x==line[t].sprite[c].position_x&&a.position_y==line[t].sprite[c].position_y&&a.position_z==line[t].sprite[c].position_z&&(n=!0),0==n&&(a.sprite_resource_id==line[t].sprite[c].sprite_resource_id&&(i=!0),1==i)){var r=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id),o=canvas.item(r);a.position_x!=line[t].sprite[c].position_x&&o.animate("left",100*a.position_x,{onChange:canvas.renderAll.bind(canvas),duration:500}),a.position_y!=line[t].sprite[c].position_y&&o.animate("top",100*a.position_y,{onChange:canvas.renderAll.bind(canvas),duration:500})}if(a.emphasize!=line[t].sprite[c].emphasize){var r=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id),o=canvas.item(r);"0"==a.emphasize?o.animate({scaleX:1,scaleY:1,left:"+=51"},{onChange:canvas.renderAll.bind(canvas),duration:100}):"1"==a.emphasize&&o.animate({scaleX:1.2,scaleY:1.2,left:"-=51"},{onChange:canvas.renderAll.bind(canvas),duration:100})}}else{var s=$(".image-cache").find("img[id="+a.sprite_resource_id+"]")[0];if(1==a.fk_effect_id){var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:100*a.position_x,opacity:1});o.set("selectable",!1),canvas.add(o)}else if(4==a.fk_effect_id){var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:-1e3,opacity:1});o.set("selectable",!1),canvas.add(o),o.animate("left",100*a.position_x,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else if(6==a.fk_effect_id){var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:1e3,opacity:1});o.set("selectable",!1),canvas.add(o),o.animate("left",100*a.position_x,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else if(8==a.fk_effect_id){var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:-800,left:100*a.position_x,opacity:1});o.set("selectable",!1),canvas.add(o),o.animate("top",100*a.position_y,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else if(10==a.fk_effect_id){var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:800,left:100*a.position_x,opacity:1});o.set("selectable",!1),canvas.add(o),o.animate("top",100*a.position_y,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else{var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:100*a.position_x,opacity:0});o.set("selectable",!1),canvas.add(o),o.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:300})}"0"==a.emphasize?o.animate({scaleX:1,scaleY:1,left:"+=51"},{onChange:canvas.renderAll.bind(canvas),duration:100}):"1"==a.emphasize&&o.animate({scaleX:1.2,scaleY:1.2,left:"-=51"},{onChange:canvas.renderAll.bind(canvas),duration:100})}}else{var s=$(".image-cache").find("img[id="+a.sprite_resource_id+"]")[0];if(1==a.fk_effect_id){var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:100*a.position_x,opacity:1});o.set("selectable",!1),canvas.add(o)}else if(4==a.fk_effect_id){var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:-1e3,opacity:1});o.set("selectable",!1),canvas.add(o),o.animate("left",100*a.position_x,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else if(6==a.fk_effect_id){var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:1e3,opacity:1});o.set("selectable",!1),canvas.add(o),o.animate("left",100*a.position_x,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else if(8==a.fk_effect_id){var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:-800,left:100*a.position_x,opacity:1});o.set("selectable",!1),canvas.add(o),o.animate("top",100*a.position_y,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else if(10==a.fk_effect_id){var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:800,left:100*a.position_x,opacity:1});o.set("selectable",!1),canvas.add(o),o.animate("top",100*a.position_y,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else{var o=new fabric.Image(s,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:100*a.position_x,opacity:0});o.set("selectable",!1),canvas.add(o),o.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:300})}"0"==a.emphasize?o.animate({scaleX:1,scaleY:1,left:"+=51"},{onChange:canvas.renderAll.bind(canvas),duration:100}):"1"==a.emphasize&&o.animate({scaleX:1.2,scaleY:1.2,left:"-=51"},{onChange:canvas.renderAll.bind(canvas),duration:100})}}),$.each(l,function(e,a){var n=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id),t=canvas.item(n);if(1==a.fk_effect_id||"skip"==game.screen){var n=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(n))}else 5==a.fk_effect_id?t.animate("left","-1000",{onChange:canvas.renderAll.bind(canvas),duration:658,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(e))}}):7==a.fk_effect_id?t.animate("left","1000",{onChange:canvas.renderAll.bind(canvas),duration:658,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(e))}}):9==a.fk_effect_id?t.animate("top","-800",{onChange:canvas.renderAll.bind(canvas),duration:658,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(e))}}):11==a.fk_effect_id?t.animate("top","800",{onChange:canvas.renderAll.bind(canvas),duration:658,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(e))}}):t.animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:665,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(e))}})})}else $.each(line[t].sprite,function(e,a){var n=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id),t=canvas.item(n);if(1==a.fk_effect_id||"skip"==game.screen){var n=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(n))}else 5==a.fk_effect_id?t.animate("left","-1000",{onChange:canvas.renderAll.bind(canvas),duration:658,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(e))}}):7==a.fk_effect_id?t.animate("left","1000",{onChange:canvas.renderAll.bind(canvas),duration:658,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(e))}}):8==a.fk_effect_id?t.animate("top","-800",{onChange:canvas.renderAll.bind(canvas),duration:658,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(e))}}):11==a.fk_effect_id?t.animate("top","800",{onChange:canvas.renderAll.bind(canvas),duration:658,onComplete:function(){var e=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id);canvas.remove(canvas.item(e))}}):t.animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:665,onComplete:function(){n=getObjectIndex(canvas.getObjects(),"line_sprite_resource_id",a.sprite_resource_id),canvas.remove(canvas.item(n))}})})}else{if(line[current.sequence].background_resource_id>0){line[current.sequence].background_resource_id;var c=line[current.sequence].background_resource_id,r=$(".image-cache").find("img[id="+c+"]")[0];if("skip"==game.screen){var o=new fabric.Image(r,{line_background_resource_id:c,top:0,left:0,opacity:1});o.set("selectable",!1),canvas.add(o),canvas.sendToBack(o)}else{var o=new fabric.Image(r,{line_background_resource_id:c,top:0,left:0,opacity:0});o.set("selectable",!1),canvas.add(o),canvas.sendToBack(o),o.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:500,onComplete:function(){}})}}line[current.sequence].sprite.length>0&&$.each(line[current.sequence].sprite,function(e,a){var n=$(".image-cache").find("img[id="+a.sprite_resource_id+"]")[0];if(1==a.fk_effect_id){var t=new fabric.Image(n,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:100*a.position_x,opacity:1});t.set("selectable",!1),canvas.add(t)}else if(4==a.fk_effect_id){var t=new fabric.Image(n,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:-1e3,opacity:1});t.set("selectable",!1),canvas.add(t),t.animate("left",100*a.position_x,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else if(6==a.fk_effect_id){var t=new fabric.Image(n,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:1e3,opacity:1});t.set("selectable",!1),canvas.add(t),t.animate("left",100*a.position_x,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else if(8==a.fk_effect_id){var t=new fabric.Image(n,{line_sprite_resource_id:a.sprite_resource_id,top:-800,left:100*a.position_x,opacity:1});t.set("selectable",!1),canvas.add(t),t.animate("top",100*a.position_y,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else if(10==a.fk_effect_id){var t=new fabric.Image(n,{line_sprite_resource_id:a.sprite_resource_id,top:800,left:100*a.position_x,opacity:1});t.set("selectable",!1),canvas.add(t),t.animate("top",100*a.position_y,{onChange:canvas.renderAll.bind(canvas),duration:1e3})}else{var t=new fabric.Image(n,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:100*a.position_x,opacity:0});t.set("selectable",!1),canvas.add(t),t.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:500})}"0"==a.emphasize?t.animate({scaleX:1,scaleY:1,left:"+=51"},{onChange:canvas.renderAll.bind(canvas),duration:100}):"1"==a.emphasize&&t.animate({scaleX:1.2,scaleY:1.2,left:"-=51"},{onChange:canvas.renderAll.bind(canvas),duration:100})})}if(line[current.sequence].content.length>0)for(var i=1;10>=i;i++){var u=getObjectIndex(canvas.getObjects(),"line_interface_id",i);canvas.bringToFront(canvas.item(u))}}else{if(line[current.sequence].background_resource_id>0){var c=line[current.sequence].background_resource_id,r=$(".image-cache").find("img[id="+c+"]")[0],o=new fabric.Image(r,{line_background_resource_id:c,top:0,left:0,opacity:0});o.set("selectable",!1),canvas.add(o),o.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:3e3})}line[current.sequence].sprite.length>0&&$.each(line[current.sequence].sprite,function(e,a){var n=$(".image-cache").find("img[id="+a.sprite_resource_id+"]")[0],t=new fabric.Image(n,{line_sprite_resource_id:a.sprite_resource_id,top:100*a.position_y,left:100*a.position_x,opacity:0});t.set("selectable",!1),canvas.add(t),t.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:500}),"0"==a.emphasize?t.animate({scaleX:1,scaleY:1,left:"+=51"},{onChange:canvas.renderAll.bind(canvas),duration:100}):"1"==a.emphasize&&t.animate({scaleX:1.2,scaleY:1.2,left:"-=51"},{onChange:canvas.renderAll.bind(canvas),duration:100})})}if("skip"!=game.screen){var v=line[current.sequence].bgm_resource_id;if(v.length){{"../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/bgm/"+line[current.sequence].bgm_file_name}playBgm(v)}else stopBgm();var g=line[current.sequence].sfx_resource_id;if(g.length){{"../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/sfx/"+line[current.sequence].sfx_file_name}setTimeout(function(){playSfx(g)},100)}else stopSfx();var f=line[current.sequence].voice_resource_id;if(f.length){{"../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/voice/"+line[current.sequence].voice_file_name}stopVoice(),setTimeout(function(){playVoice(f)},200)}else stopVoice()}context.clearRect(0,0,text_display.width,text_display.height),line[current.sequence].content.length>0&&renderLineText(line[current.sequence].content),0==current.sequence&&1==line[current.sequence].fk_linetype_id&&renderInGameInterface(),line[current.sequence].speaker.length>0?renderSpeaker():removeSpeaker()}else if(2===parseInt(line[current.sequence].fk_linetype_id)){if(line[current.sequence].choice.length>0){game.screen="choice";var _=200;3==line[current.sequence].choice.length?_=180:4==line[current.sequence].choice.length&&(_=160);for(var i=0;i<line[current.sequence].choice.length;i++){var r=$(".interface").find("img[id=in_choice_box]")[0],m=new fabric.Image(r,{originX:"center",originY:"center",opacity:0,scaleX:.8}),p=line[current.sequence].choice[i].content,b=getObjectIndex(font_list,"fonttype_id",configuration.fk_fonttype_id),h=new fabric.Text(p,{fontSize:20,fontFamily:font_list[b].name,opacity:0,originX:"center",originY:"center"}),x=new fabric.Group([m,h],{line_choice_id:line[current.sequence].choice[i].choice_id,top:_,left:100});x.set("selectable",!1),canvas.add(x),x.animate("opacity","0.9",{onChange:canvas.renderAll.bind(canvas),duration:1e3});{line[current.sequence].choice.length}2==line[current.sequence].choice.length?_+=80:3==line[current.sequence].choice.length?_+=70:4==line[current.sequence].choice.length&&(_+=60)}}}else if(3===parseInt(line[current.sequence].fk_linetype_id)){if(line[current.sequence].video_resource_id>0){game.screen="stall";var y="../../../resources/"+configuration.creator_id+"/"+configuration.game_id+"/video/"+line[current.sequence].video_file_name;$(".video-area").html(""),"fullscreen"==game.mode?$("<video/>").attr("src",y).attr("id","video_play").attr("width",screen.height/6*8).attr("height",screen.height).appendTo(".video-area"):$("<video/>").attr("src",y).attr("id","video_play").attr("width",800).attr("height",600).appendTo(".video-area"),stopBgm(),blackIn(2e3,function(){setTimeout(function(){var e=$("#video_play")[0];$(".text-area").fadeOut(1e3),$(".video-area").fadeIn(1e3,function(){game.screen="video"}),e.play(),e.onended=function(){$(".video-area").fadeOut(2e3),setTimeout(function(){$(".text-area").fadeIn(1e3),game.screen="play"},1e3)},blackOut(1e3,function(){})},3e3)})}}else 4===parseInt(line[current.sequence].fk_linetype_id)&&(game.screen="stall",$(".text-area").fadeOut(1e3),whiteIn(2e3,function(){context.clearRect(0,0,text_display.width,text_display.height),stopBgm(),canvas.clear(),current.sequence=-1,current.head=-1,line=[],callSequentialLineData(0,function(){processSequentialResource()}),setTimeout(function(){$(".text-area").show(),renderTitleScreen(),game.screen="title"},5e3)}));e&&e()}function renderSpeaker(){var e=getObjectIndex(canvas.getObjects(),"id","speaker");canvas.remove(canvas.item(e));var a=getObjectIndex(font_list,"fonttype_id",configuration.fk_fonttype_id),n=new fabric.Text(line[current.sequence].speaker,{id:"speaker",fontSize:22,fontFamily:font_list[a].name,fill:"#000000",opacity:1,top:460,left:230,originX:"center",originY:"bottom"});n.set("selectable",!1),canvas.add(n)}function removeSpeaker(){var e=getObjectIndex(canvas.getObjects(),"id","speaker");canvas.remove(canvas.item(e))}function playAuto(){var e=1e3;"auto"==game.screen&&("idle"==game.status.text&&"idle"==game.status.voice&&(renderNextLine(),maintainCurrent(),maintainCache()),setTimeout(function(){playAuto()},e))}function playSkip(){var e=200;"skip"==game.screen&&(renderNextLine(),maintainCurrent(),maintainCache(),setTimeout(function(){playSkip()},e))}function renderLogScreen(){var e,a=current.sequence-50;for(e=0>a?0:a,$(".log-area").html("<h2>Backlog</h2>"),e;e<current.sequence;e++)1==line[e].fk_linetype_id?$("<li/>").text(line[e].content).appendTo(".log-area"):a++;var n=$(".log-area")[0];n.scrollTop=n.scrollHeight,$(".log-area").slideDown(1e3)}function exitChoice(e){$.each(line[current.sequence].choice,function(a,n){var t=getObjectIndex(canvas.getObjects(),"line_choice_id",n.choice_id),i=canvas.item(t);i.animate("opacity","0",{onChange:canvas.renderAll.bind(canvas),duration:500,onComplete:function(){t=getObjectIndex(canvas.getObjects(),"line_choice_id",n.choice_id),canvas.remove(canvas.item(t)),e&&e()}})})}function renderInGameInterface(e){var a=$(".interface").find("img[id=in_text_window]")[0],n=new fabric.Image(a,{id:"text_box",line_interface_id:1,top:420,left:0,opacity:.8});n.set("selectable",!1),canvas.add(n);var a=$(".interface").find("img[id=in_quickload_button]")[0],t=new fabric.Image(a,{id:"quickload_button",line_interface_id:2,top:435,left:480,opacity:1});t.set("selectable",!1),canvas.add(t);var a=$(".interface").find("img[id=in_quicksave_button]")[0],i=new fabric.Image(a,{id:"quicksave_button",line_interface_id:3,top:438,left:545,opacity:1});i.set("selectable",!1),canvas.add(i);var a=$(".interface").find("img[id=in_load_button]")[0],c=new fabric.Image(a,{id:"load_button",line_interface_id:4,top:435,left:615,opacity:1});c.set("selectable",!1),canvas.add(c);var a=$(".interface").find("img[id=in_save_button]")[0],r=new fabric.Image(a,{id:"save_button",line_interface_id:5,top:438,left:670,opacity:1});r.set("selectable",!1),canvas.add(r);var a=$(".interface").find("img[id=in_log_button]")[0],o=new fabric.Image(a,{id:"log_button",line_interface_id:6,top:435,left:720,opacity:1});o.set("selectable",!1),canvas.add(o);var a=$(".interface").find("img[id=in_auto_button]")[0],s=new fabric.Image(a,{id:"auto_button",line_interface_id:7,top:470,left:20,opacity:1});s.set("selectable",!1),canvas.add(s);var a=$(".interface").find("img[id=in_skip_button]")[0],d=new fabric.Image(a,{id:"skip_button",line_interface_id:8,top:468,left:720,opacity:1});d.set("selectable",!1),canvas.add(d);var a=$(".interface").find("img[id=in_repeat_button]")[0],l=new fabric.Image(a,{id:"repeat_button",line_interface_id:9,top:530,left:15,opacity:1});l.set("selectable",!1),canvas.add(l);var a=$(".interface").find("img[id=in_configuration_button]")[0],u=new fabric.Image(a,{id:"configuration_button",line_interface_id:10,top:526,left:715,opacity:1});u.set("selectable",!1),canvas.add(u),e&&e()}function play(e){var a=$("#"+e)[0];game.bgm!=e&&a.paused&&(a.volume=configuration.bgm_volume,"boolean"==typeof a.loop?a.loop=!0:a.addEventListener("ended",function(){this.currentTime=0,this.play()},!1),a.play(),game.bgm=e)}function playBgm(e){if(game.bgm!=e){var a=$("#"+game.bgm),n=a[0];""!=game.bgm&&a.animate({volume:0},500,function(){n.pause(),n.currentTime=0});var t=$("#"+e),i=t[0];i.volume=0,t.animate({volume:configuration.bgm_volume},500),"boolean"==typeof i.loop?i.loop=!0:i.addEventListener("ended",function(){this.currentTime=0,this.play()},!1),i.play(),game.bgm=e}}function stopBgm(){if(""!=game.bgm){var e=$("#"+game.bgm),a=e[0];a.paused||e.animate({volume:0},3e3,function(){a.pause(),a.currentTime=0})}}function playSfx(e){if(game.sfx!=e){var a=$("#"+game.sfx),n=a[0];""!=game.sfx&&(n.paused||(n.pause(),n.currentTime=0)),n=$("#"+e)[0],n.play(),game.sfx=e}}function stopSfx(){if(""!=game.sfx){var e=$("#"+game.sfx)[0];e.pused&&(e.pause(),e.currentTime=0)}}function playVoice(e){if("idle"==game.status.voice){if(e){var a=$("#"+e)[0];game.voice=e}else var a=$("#"+game.voice)[0];a.volume=configuration.voice_volume,a.loop=!1,game.status.voice="busy",a.play(),a.onended=function(){game.status.voice="idle"}}}function stopVoice(){if(""!=game.voice){var e=$("#"+game.voice)[0];e.paused||(e.pause(),e.currentTime=0,game.status.voice="idle")}}function renderLineText(e){var a=getObjectIndex(font_list,"fonttype_id",configuration.fk_fonttype_id);context.font="20px "+font_list[a].name;var n=5*parseInt(configuration.text_speed),t=100,i=490,c=t,r=31,o=100,r=r||32;o=o||10;var s=0;if("skip"==game.screen||0==n)for(var s=0;s<=e.length;s++){var d=e.substr(s),l=d.indexOf(" ");l=-1==l?e.length:l;var u=context.measureText(d.substring(0,l)).width,v=context.measureText(e.charAt(s)).width;t+u>=text_display.width-o&&(t=c,i+=r),context.fillText(e.charAt(s),t,i),t+=v}else{game.status.text="busy";var g=setInterval(function(){var a=e.substr(s),n=a.indexOf(" ");n=-1==n?e.length:n;var d=context.measureText(a.substring(0,n)).width,l=context.measureText(e.charAt(s)).width;t+d>=text_display.width-o&&(t=c,i+=r),context.fillText(e.charAt(s),t,i),s++,t+=l,s===e.length&&(clearInterval(g),game.status.text="idle")},n)}}var configuration=[],line=[],current={sequence:-1,head:-1,limit:100},cache={head:-1,limit:60,count:0},game={screen:"title",mode:"normal",bgm:"",voice:"",sfx:"",status:{text:"idle",voice:"idle"}},font_list=[],visual_display=$("#visual")[0];visual_display.width=800,visual_display.height=600,visual_display.style.width="800px",visual_display.style.height="600px";var text_display=$("#text")[0];text_display.width=800,text_display.height=600,text_display.style.width="800px",text_display.style.height="600px";var context=text_display.getContext("2d"),canvas=new fabric.Canvas("visual");canvas.selection=!1,canvas.backgroundColor="rgba(255, 255, 255,1)",$(document).ready(function(){callConfigurationData(function(){preloadInterface(function(){callSequentialLineData(0,function(){processSequentialResource(),setTimeout(function(){initializeGame()},100)})})}),callFontData()}),document.addEventListener("fullscreenchange",function(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||"fullscreen"!=game.mode||toggleFullscreen()}),document.addEventListener("webkitfullscreenchange",function(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||"fullscreen"!=game.mode||toggleFullscreen()}),document.addEventListener("mozfullscreenchange",function(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||"fullscreen"!=game.mode||toggleFullscreen()}),document.addEventListener("MSFullscreenChange",function(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||"fullscreen"!=game.mode||toggleFullscreen()});var key_enable=!0;$(document).bind("keydown",function(e){if(1==key_enable&&"play"==game.screen)switch(e.which){case 13:key_enable=!1,"busy"==game.status.text||e.altKey||(renderNextLine(),maintainCurrent(),maintainCache())}13==e.which&&e.altKey&&toggleFullscreen()}),$(document).bind("keyup",function(e){if("play"==game.screen)switch(e.keyCode){case 13:key_enable=!0}}),canvas.on("mouse:down",function(e){if("title"==game.screen)switch(e.target.id){case"start_button":renderPlayScreen(),game.screen="play";break;case"load_button":renderLoadScreen(),game.screen="load";break;case"configuration_button":renderConfigurationScreen(),game.screen="configuration";break;case"continue_button":quickLoad();break;case"exit_button":window.location.replace(config.base+"index.php/release")}else if("configuration"==game.screen||"on_play_configuration"==game.screen||"on_choice_configuration"==game.screen)switch(e.target.id){case"font":var a=getObjectIndex(canvas.getObjects(),"fonttype_id",configuration.fk_fonttype_id);n=canvas.item(a),n.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:100});var a=getObjectIndex(canvas.getObjects(),"fonttype_id",e.target.fonttype_id);n=canvas.item(a),n.animate("opacity","0.5",{onChange:canvas.renderAll.bind(canvas),duration:100}),configuration.fk_fonttype_id=e.target.fonttype_id;break;case"text":var a=getObjectIndex(canvas.getObjects(),"textspeed_id",configuration.text_speed),n=canvas.item(a);n.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:100});var a=getObjectIndex(canvas.getObjects(),"textspeed_id",e.target.textspeed_id);n=canvas.item(a),n.animate("opacity","0.5",{onChange:canvas.renderAll.bind(canvas),duration:100}),configuration.text_speed=e.target.textspeed_id;break;case"bgm":var t=10*configuration.bgm_volume,a=getObjectIndex(canvas.getObjects(),"bgmvolume_id",t),n=canvas.item(a);n.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:100});var a=getObjectIndex(canvas.getObjects(),"bgmvolume_id",e.target.bgmvolume_id);n=canvas.item(a),n.animate("opacity","0.5",{onChange:canvas.renderAll.bind(canvas),duration:100});var i=e.target.bgmvolume_id/10;configuration.bgm_volume=i;break;case"sfx":var t=10*configuration.sfx_volume,a=getObjectIndex(canvas.getObjects(),"sfxvolume_id",t),n=canvas.item(a);n.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:100});var a=getObjectIndex(canvas.getObjects(),"sfxvolume_id",e.target.sfxvolume_id);n=canvas.item(a),n.animate("opacity","0.5",{onChange:canvas.renderAll.bind(canvas),duration:100});var i=e.target.sfxvolume_id/10;configuration.sfx_volume=i;break;case"voice":var t=10*configuration.voice_volume,a=getObjectIndex(canvas.getObjects(),"voicevolume_id",t),n=canvas.item(a);n.animate("opacity","1",{onChange:canvas.renderAll.bind(canvas),duration:100});var a=getObjectIndex(canvas.getObjects(),"voicevolume_id",e.target.voicevolume_id);n=canvas.item(a),n.animate("opacity","0.5",{onChange:canvas.renderAll.bind(canvas),duration:100});var i=e.target.voicevolume_id/10;configuration.voice_volume=i;break;case"text_head":toTextConfiguration();break;case"sound_head":toSoundConfiguration();break;case"exit_button":exitConfigurationScreen(),callSaveConfiguration(),"configuration"==game.screen?game.screen="title":"on_play_configuration"==game.screen?game.screen="play":"on_choice_configuration"==game.screen&&(game.screen="choice")}else if("play"==game.screen)if(void 0!=e.target)switch(e.target.id){case"quickload_button":quickLoad();break;case"quicksave_button":quickSave();break;case"load_button":game.screen="on_play_load",$(".text-area").fadeOut(1e3),renderLoadScreen();break;case"save_button":game.screen="save",$(".text-area").fadeOut(1e3),renderSaveScreen();break;case"auto_button":game.screen="auto",playAuto();break;case"skip_button":"busy"!=game.status.text&&(game.screen="skip",playSkip());break;case"repeat_button":playVoice();break;case"configuration_button":game.screen="on_play_configuration",renderConfigurationScreen(),$(text_display).fadeOut(1e3);break;case"log_button":game.screen="log",renderLogScreen();break;default:"busy"!=game.status.text&&(renderNextLine(),maintainCurrent(),maintainCache())}else"busy"!=game.status.text&&(renderNextLine(),maintainCurrent(),maintainCache());else if("save"==game.screen||"on_choice_save"==game.screen)switch(e.target.id){case"save_slot":e.target.save_data_line_id?saveGame(e.target.save_data_id,function(){exitSaveScreen(function(){$(".text-area").fadeIn(1e3),game.screen="on_choice_save"==game.screen?"choice":"play"})}):(game.screen="stall",saveGame(e.target.save_data_id,function(){exitSaveScreen(function(){game.screen="on_choice_save"==game.screen?"choice":"play"})}));break;case"exit_button":$(".text-area").fadeIn(2e3),exitSaveScreen(function(){game.screen="on_choice_save"==game.screen?"choice":"play"})}else if("load"==game.screen||"on_play_load"==game.screen||"on_choice_load"==game.screen)switch(e.target.id){case"save_slot":e.target.save_data_line_id&&(game.screen="stall",loadGame(e.target.save_data_line_id));break;case"exit_button":$(".text-area").fadeIn(2e3),exitLoadScreen(function(){game.screen="on_choice_load"==game.screen?"choice":"on_play_load"==game.screen?"play":"title"})}else if("choice"==game.screen)if(e.target.line_choice_id){var c=e.target.line_choice_id,r=getObjectIndex(line[current.sequence].choice,"choice_id",c);if(line[current.sequence].choice[r].jumpto_line_id.length>0&&line[current.sequence].choice[r].jumpto_line_id!=line[current.sequence+1].line_id){game.screen="stall";var o=current.sequence+1;line.splice(o,current.head-current.sequence),current.head=current.sequence,cache.head=current.sequence;var s=line[current.sequence].choice[r].look_ahead[0].sequence;callSequentialLineData(parseInt(s)-1,function(){processSequentialResource(),exitChoice(),setTimeout(function(){game.screen="play",renderNextLine()},500)})}else exitChoice(),setTimeout(function(){renderNextLine(),game.screen="play"},500)}else switch(e.target.id){case"quickload_button":quickLoad();break;case"quicksave_button":quickSave();break;case"load_button":game.screen="on_choice_load",$(".text-area").fadeOut(1e3),renderLoadScreen();break;case"save_button":game.screen="on_choice_save",$(".text-area").fadeOut(1e3),renderSaveScreen();
break;case"auto_button":break;case"skip_button":break;case"repeat_button":playVoice();break;case"configuration_button":renderConfigurationScreen(),$(text_display).fadeOut(1e3),game.screen="on_choice_configuration";break;case"log_button":}else if("video"==game.screen){game.screen="stall";var d=$("#video_play");d.animate({volume:0},3e3,function(){var e=$("#video_play")[0];e.pause()}),whiteIn(1e3,function(){$(".video-area").fadeOut(2e3),setTimeout(function(){renderNextLine(),$(".text-area").fadeIn(2500),whiteOut(2e3,function(){$(".text-area").fadeIn(1e3),game.screen="play"})},3e3)})}else"auto"==game.screen?game.screen="play":"skip"==game.screen?game.screen="play":"log"==game.screen&&($(".log-area").slideUp(1e3),game.screen="play")});for(var i=0;i<font_list.length;i++){var index_to_read=getObjectIndex(canvas.getObjects(),"fonttype_id",font_list[i].fonttype_id);canvas.remove(canvas.item(index_to_read))}for(i=0;10>=i;i++){var index_to_read=getObjectIndex(canvas.getObjects(),"bgmvolume_id",i);canvas.remove(canvas.item(index_to_read))}